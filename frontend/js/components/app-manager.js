// ===============================================
// APP MANAGER - ORQUESTADOR PRINCIPAL
// ===============================================

/**
 * M√≥dulo principal que orquesta toda la aplicaci√≥n
 * Coordina: SupermercadosManager, ProductosManager, FiltrosManager, EventManager
 */

// ===============================================
// CONFIGURACI√ìN DE LA APLICACI√ìN
// ===============================================

const CONFIG_APP = {
  contenedor_principal: "app-container",
  orden_carga: [
    "supermercados",
    "productos", 
    "filtros",
    "eventos"
  ],
  modulos_requeridos: [
    "SupermercadosManager",
    "ProductosManager", 
    "FiltrosManager",
    "EventManager",
    "DataManager",
    "AuthManager"
  ],
  tiempos_espera: {
    entre_modulos: 50,
    post_render: 100,
    validacion_final: 200
  }
};

// Estado de la aplicaci√≥n
let estadoApp = {
  inicializada: false,
  modulosListos: [],
  errores: [],
  tiempoInicio: null,
  tiempoFinalizacion: null
};

// ===============================================
// VERIFICACI√ìN DE DEPENDENCIAS
// ===============================================

/**
 * Verifica que todos los m√≥dulos requeridos est√©n disponibles
 */
function verificarDependencias() {
  console.log("üîç Verificando dependencias de la aplicaci√≥n...");
  
  const modulosFaltantes = CONFIG_APP.modulos_requeridos.filter(modulo => !window[modulo]);
  
  if (modulosFaltantes.length > 0) {
    console.error("‚ùå M√≥dulos faltantes:", modulosFaltantes);
    estadoApp.errores.push(`M√≥dulos faltantes: ${modulosFaltantes.join(", ")}`);
    return false;
  }
  
  console.log("‚úÖ Todas las dependencias est√°n disponibles");
  return true;
}

/**
 * Verifica que el contenedor principal exista
 */
function verificarContenedorPrincipal() {
  const container = document.getElementById(CONFIG_APP.contenedor_principal);
  
  if (!container) {
    console.error(`‚ùå Contenedor principal '${CONFIG_APP.contenedor_principal}' no encontrado`);
    estadoApp.errores.push("Contenedor principal no encontrado");
    return false;
  }
  
  console.log("‚úÖ Contenedor principal encontrado");
  return true;
}

// ===============================================
// INICIALIZACI√ìN DE M√ìDULOS
// ===============================================

/**
 * Inicializa todos los m√≥dulos en el orden correcto
 */
async function inicializarModulos() {
  console.log("üöÄ Iniciando secuencia de inicializaci√≥n de m√≥dulos...");
  
  try {
    // 1. Inicializar DataManager
    await inicializarModulo("DataManager");
    
    // 2. Inicializar AuthManager
    await inicializarModulo("AuthManager");
    
    // 3. Inicializar SupermercadosManager
    await inicializarModulo("SupermercadosManager");
    
    // 4. Inicializar ProductosManager
    await inicializarModulo("ProductosManager");
    
    // 5. FiltrosManager se inicializa autom√°ticamente cuando se renderiza ProductosManager
    
    // 6. Inicializar EventManager
    await inicializarModulo("EventManager");
    
    console.log("‚úÖ Todos los m√≥dulos inicializados correctamente");
    return true;
    
  } catch (error) {
    console.error("‚ùå Error durante la inicializaci√≥n de m√≥dulos:", error);
    estadoApp.errores.push(`Error de inicializaci√≥n: ${error.message}`);
    return false;
  }
}

/**
 * Inicializa un m√≥dulo espec√≠fico
 */
async function inicializarModulo(nombreModulo) {
  console.log(`üîß Inicializando ${nombreModulo}...`);
  
  const modulo = window[nombreModulo];
  
  if (!modulo) {
    throw new Error(`M√≥dulo ${nombreModulo} no encontrado`);
  }
  
  if (typeof modulo.inicializar === 'function') {
    modulo.inicializar();
  }
  
  estadoApp.modulosListos.push(nombreModulo);
  
  // Esperar un poco entre m√≥dulos
  await esperar(CONFIG_APP.tiempos_espera.entre_modulos);
  
  console.log(`‚úÖ ${nombreModulo} inicializado`);
}

// ===============================================
// RENDERIZADO DE LA APLICACI√ìN
// ===============================================

/**
 * Renderiza toda la aplicaci√≥n
 */
async function renderizarAplicacion() {
  console.log("üé® Iniciando renderizado de la aplicaci√≥n...");
  
  try {
    // Renderizar secci√≥n completa (supermercados + productos)
    const resultado = window.ProductosManager.renderizarSeccionCompleta(CONFIG_APP.contenedor_principal);
    
    if (!resultado) {
      throw new Error("Error al renderizar la secci√≥n principal");
    }
    
    // Esperar un poco para que el DOM se estabilice
    await esperar(CONFIG_APP.tiempos_espera.post_render);
    
    console.log("‚úÖ Aplicaci√≥n renderizada correctamente");
    return true;
    
  } catch (error) {
    console.error("‚ùå Error durante el renderizado:", error);
    estadoApp.errores.push(`Error de renderizado: ${error.message}`);
    return false;
  }
}

// ===============================================
// VALIDACI√ìN FINAL
// ===============================================

/**
 * Realiza validaciones finales de la aplicaci√≥n
 */
async function validarAplicacionFinal() {
  console.log("üîé Realizando validaciones finales...");
  
  // Esperar un poco para que todo se estabilice
  await esperar(CONFIG_APP.tiempos_espera.validacion_final);
  
  const validaciones = [
    {
      nombre: "SupermercadosManager",
      test: () => document.getElementById("supermercados-section") !== null
    },
    {
      nombre: "ProductosManager", 
      test: () => document.getElementById("productos-section") !== null
    },
    {
      nombre: "FiltrosManager",
      test: () => window.FiltrosManager && window.ProductosManager.estaIntegrado()
    },
    {
      nombre: "EventManager",
      test: () => window.EventManager !== undefined
    },
    {
      nombre: "Elementos cr√≠ticos",
      test: () => {
        const elementos = ["producto", "tipo-de-producto", "supermercado-buttons"];
        return elementos.every(id => document.getElementById(id) !== null);
      }
    }
  ];
  
  const validacionesFallidas = validaciones.filter(v => {
    try {
      return !v.test();
    } catch (error) {
      console.error(`Error en validaci√≥n ${v.nombre}:`, error);
      return true;
    }
  });
  
  if (validacionesFallidas.length > 0) {
    console.warn("‚ö†Ô∏è Validaciones fallidas:", validacionesFallidas.map(v => v.nombre));
    estadoApp.errores.push(`Validaciones fallidas: ${validacionesFallidas.map(v => v.nombre).join(", ")}`);
    return false;
  }
  
  console.log("‚úÖ Todas las validaciones finales pasaron");
  return true;
}

// ===============================================
// GESTI√ìN DE ERRORES
// ===============================================

/**
 * Maneja los errores de la aplicaci√≥n
 */
function manejarErrores() {
  if (estadoApp.errores.length === 0) return;
  
  console.error("‚ùå Errores encontrados durante la inicializaci√≥n:");
  estadoApp.errores.forEach((error, index) => {
    console.error(`${index + 1}. ${error}`);
  });
  
  // En desarrollo, mostrar errores al usuario
  const esDesarrollo = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
  
  if (esDesarrollo) {
    const mensaje = `Errores de inicializaci√≥n:\n${estadoApp.errores.join('\n')}`;
    console.warn("Mostrando errores en desarrollo:", mensaje);
    // No usar alert() para no interrumpir el desarrollo
  }
}

/**
 * Recuperaci√≥n de errores cr√≠ticos
 */
function intentarRecuperacion() {
  console.log("üîÑ Intentando recuperaci√≥n de errores...");
  
  // Estrategias de recuperaci√≥n
  const estrategias = [
    {
      nombre: "Reintento de inicializaci√≥n",
      accion: () => {
        setTimeout(() => {
          console.log("üîÑ Reintentando inicializaci√≥n...");
          inicializarAplicacion();
        }, 2000);
      }
    }
  ];
  
  // Por ahora, solo log
  console.log("üí° Estrategias de recuperaci√≥n disponibles:", estrategias.map(e => e.nombre));
}

// ===============================================
// UTILIDADES
// ===============================================

/**
 * Funci√≥n de espera (Promise-based)
 */
function esperar(milisegundos) {
  return new Promise(resolve => setTimeout(resolve, milisegundos));
}

/**
 * Calcula estad√≠sticas de rendimiento
 */
function calcularEstadisticas() {
  if (!estadoApp.tiempoInicio || !estadoApp.tiempoFinalizacion) return null;
  
  const tiempoTotal = estadoApp.tiempoFinalizacion - estadoApp.tiempoInicio;
  
  return {
    tiempoTotal: `${tiempoTotal}ms`,
    modulosInicializados: estadoApp.modulosListos.length,
    erroresEncontrados: estadoApp.errores.length,
    estado: estadoApp.inicializada ? "‚úÖ Exitosa" : "‚ùå Fallida"
  };
}

// ===============================================
// FUNCI√ìN PRINCIPAL DE INICIALIZACI√ìN
// ===============================================

/**
 * Inicializa completamente la aplicaci√≥n
 */
async function inicializarAplicacion() {
  console.log("üöÄ === INICIANDO CAMINANDO.ONLINE ===");
  
  estadoApp.tiempoInicio = Date.now();
  estadoApp.errores = [];
  estadoApp.modulosListos = [];
  
  try {
    // 1. Verificar dependencias
    if (!verificarDependencias()) {
      throw new Error("Dependencias faltantes");
    }
    
    // 2. Verificar contenedor principal
    if (!verificarContenedorPrincipal()) {
      throw new Error("Contenedor principal no encontrado");
    }
    
    // 3. Inicializar m√≥dulos
    const modulosOK = await inicializarModulos();
    if (!modulosOK) {
      throw new Error("Error en inicializaci√≥n de m√≥dulos");
    }
    
    // 4. Renderizar aplicaci√≥n
    const renderOK = await renderizarAplicacion();
    if (!renderOK) {
      throw new Error("Error en renderizado");
    }
    
    // 5. Validaci√≥n final
    const validacionOK = await validarAplicacionFinal();
    if (!validacionOK) {
      console.warn("‚ö†Ô∏è Aplicaci√≥n inicializada con advertencias");
    }
    
    // 6. Marcar como inicializada
    estadoApp.inicializada = true;
    estadoApp.tiempoFinalizacion = Date.now();
    
    // 7. Mostrar estad√≠sticas
    const stats = calcularEstadisticas();
    console.log("üìä Estad√≠sticas de inicializaci√≥n:", stats);
    
    console.log("üéâ === CAMINANDO.ONLINE INICIALIZADA EXITOSAMENTE ===");
    
  } catch (error) {
    console.error("üí• Error cr√≠tico durante la inicializaci√≥n:", error);
    estadoApp.errores.push(`Error cr√≠tico: ${error.message}`);
    estadoApp.tiempoFinalizacion = Date.now();
    
    // Manejar errores
    manejarErrores();
    
    // Intentar recuperaci√≥n
    intentarRecuperacion();
  }
}

// ===============================================
// API P√öBLICA Y EVENTOS
// ===============================================

/**
 * API p√∫blica del AppManager
 */
window.AppManager = {
  // Inicializaci√≥n
  inicializar: inicializarAplicacion,
  
  // Estado
  obtenerEstado: () => ({ ...estadoApp }),
  estaInicializada: () => estadoApp.inicializada,
  
  // Estad√≠sticas
  obtenerEstadisticas: calcularEstadisticas,
  
  // Configuraci√≥n
  configuracion: CONFIG_APP,
  
  // Utilidades
  esperar: esperar
};

// Event listener para inicializaci√≥n autom√°tica
document.addEventListener("DOMContentLoaded", () => {
  console.log("üìã DOM cargado, iniciando AppManager...");
  
  // Esperar un poco para que todos los m√≥dulos se carguen
  setTimeout(() => {
    inicializarAplicacion();
  }, 100);
});

console.log("üì¶ AppManager cargado");
