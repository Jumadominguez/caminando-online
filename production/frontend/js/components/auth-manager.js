// ===============================================
// AUTH MANAGER - GESTI√ìN DE AUTENTICACI√ìN Y NAVEGACI√ìN
// ===============================================

/**
 * M√≥dulo responsable de gestionar la autenticaci√≥n y navegaci√≥n din√°mica
 * Incluye: detecci√≥n de usuario, navegaci√≥n adaptativa, redirecciones
 */

// ===============================================
// CONFIGURACI√ìN DEL M√ìDULO
// ===============================================

const CONFIG_AUTH = {
  storage_keys: {
    user_token: "caminando_user_token",
    user_data: "caminando_user_data",
    remember_me: "caminando_remember_me"
  },
  rutas: {
    login: "/private/auth/login.html",
    registro: "/private/auth/registro.html", 
    dashboard: "/private/dashboard/dashboard.html",
    perfil: "/private/dashboard/perfil.html",
    home: "/index.html"
  },
  nav_config: {
    no_autenticado: {
      texto: "Iniciar Sesi√≥n",
      enlace: "/private/auth/login.html",
      clase: "auth-login-btn"
    },
    autenticado: {
      texto: "Mi Perfil",
      enlace: "/private/dashboard/dashboard.html", 
      clase: "user-profile-btn"
    }
  }
};

// Estado del m√≥dulo
let usuarioActual = null;
let estaAutenticado = false;
let navElement = null;

// ===============================================
// INICIALIZACI√ìN
// ===============================================

/**
 * Inicializa el sistema de autenticaci√≥n
 */
function inicializarAuth() {
  console.log("üîê Inicializando AuthManager...");
  
  // Verificar estado de autenticaci√≥n
  verificarEstadoAutenticacion();
  
  // Actualizar navegaci√≥n
  actualizarNavegacion();
  
  // Configurar event listeners
  configurarEventListeners();
  
  console.log("‚úÖ AuthManager inicializado");
}

/**
 * Verifica si el usuario est√° autenticado
 */
function verificarEstadoAutenticacion() {
  console.log("üîç Verificando estado de autenticaci√≥n...");
  
  try {
    // Buscar token en localStorage o sessionStorage
    const token = localStorage.getItem(CONFIG_AUTH.storage_keys.user_token) || 
                  sessionStorage.getItem(CONFIG_AUTH.storage_keys.user_token);
    
    const userData = localStorage.getItem(CONFIG_AUTH.storage_keys.user_data) ||
                     sessionStorage.getItem(CONFIG_AUTH.storage_keys.user_data);
    
    if (token && userData) {
      usuarioActual = JSON.parse(userData);
      estaAutenticado = true;
      console.log("‚úÖ Usuario autenticado:", usuarioActual.email || usuarioActual.nombre);
    } else {
      usuarioActual = null;
      estaAutenticado = false;
      console.log("‚ÑπÔ∏è Usuario no autenticado (invitado)");
    }
  } catch (error) {
    console.error("‚ùå Error verificando autenticaci√≥n:", error);
    usuarioActual = null;
    estaAutenticado = false;
  }
  
  return estaAutenticado;
}

// ===============================================
// GESTI√ìN DE NAVEGACI√ìN
// ===============================================

/**
 * Actualiza la navegaci√≥n seg√∫n el estado de autenticaci√≥n
 */
function actualizarNavegacion() {
  console.log("üß≠ Actualizando navegaci√≥n...");
  
  // VERIFICAR SI ESTAMOS EN UNA P√ÅGINA DEL DASHBOARD
  const isDashboardPage = window.location.pathname.includes('/private/dashboard/');
  
  if (isDashboardPage) {
    console.log("üìä P√°gina del dashboard detectada - no modificar navegaci√≥n");
    return; // No modificar la navegaci√≥n en p√°ginas del dashboard
  }
  
  // Buscar elemento de navegaci√≥n
  navElement = document.querySelector("header nav ul");
  
  if (!navElement) {
    console.warn("‚ö†Ô∏è Elemento de navegaci√≥n no encontrado");
    return;
  }
  
  // Limpiar navegaci√≥n actual
  navElement.innerHTML = "";
  
  // Generar navegaci√≥n seg√∫n estado
  if (estaAutenticado) {
    generarNavegacionAutenticado();
  } else {
    generarNavegacionInvitado();
  }
  
  console.log("‚úÖ Navegaci√≥n actualizada");
}

/**
 * Genera navegaci√≥n para usuario no autenticado (invitado)
 */
function generarNavegacionInvitado() {
  const navItems = [
    {
      texto: "Iniciar Sesi√≥n",
      enlace: CONFIG_AUTH.rutas.login,
      clase: "nav-auth-login",
      icono: ""
    },
    {
      texto: "Registrarse",
      enlace: CONFIG_AUTH.rutas.registro,
      clase: "nav-auth-registro", 
      icono: ""
    }
  ];
  
  navItems.forEach(item => {
    const li = document.createElement("li");
    const a = document.createElement("a");
    
    a.href = item.enlace;
    a.className = item.clase;
    
    // Envolver el texto en span para el bot√≥n de registro (para efectos CSS)
    if (item.clase === "nav-auth-registro") {
      const span = document.createElement("span");
      span.textContent = item.texto;
      a.appendChild(span);
    } else {
      a.textContent = item.texto;
    }
    
    // Event listener para navegaci√≥n
    a.addEventListener("click", (e) => {
      e.preventDefault();
      navegarA(item.enlace);
    });
    
    li.appendChild(a);
    navElement.appendChild(li);
  });
  
  console.log("‚úÖ Navegaci√≥n de invitado generada");
}

/**
 * Genera navegaci√≥n para usuario autenticado
 */
function generarNavegacionAutenticado() {
  const navItems = [
    {
      texto: "Dashboard",
      enlace: CONFIG_AUTH.rutas.dashboard,
      clase: "nav-dashboard",
      icono: ""
    },
    {
      texto: "Mi Perfil",
      enlace: CONFIG_AUTH.rutas.perfil,
      clase: "nav-perfil",
      icono: ""
    },
    {
      texto: "Cerrar Sesi√≥n",
      enlace: "#logout",
      clase: "nav-logout",
      icono: "",
      accion: "logout"
    }
  ];
  
  navItems.forEach(item => {
    const li = document.createElement("li");
    const a = document.createElement("a");
    
    a.href = item.enlace;
    a.className = item.clase;
    a.textContent = item.texto;
    
    // Event listener especial para logout
    if (item.accion === "logout") {
      a.addEventListener("click", (e) => {
        e.preventDefault();
        cerrarSesion();
      });
    } else {
      a.addEventListener("click", (e) => {
        e.preventDefault();
        navegarA(item.enlace);
      });
    }
    
    li.appendChild(a);
    navElement.appendChild(li);
  });
  
  console.log("‚úÖ Navegaci√≥n de usuario autenticado generada");
}

// ===============================================
// GESTI√ìN DE SESIONES
// ===============================================

/**
 * Inicia sesi√≥n del usuario
 */
function iniciarSesion(userData, token, recordarme = false) {
  console.log("üîê Iniciando sesi√≥n...", userData.email);
  
  try {
    usuarioActual = userData;
    estaAutenticado = true;
    
    // Guardar en storage apropiado
    const storage = recordarme ? localStorage : sessionStorage;
    
    storage.setItem(CONFIG_AUTH.storage_keys.user_token, token);
    storage.setItem(CONFIG_AUTH.storage_keys.user_data, JSON.stringify(userData));
    
    if (recordarme) {
      localStorage.setItem(CONFIG_AUTH.storage_keys.remember_me, "true");
    }
    
    // Actualizar navegaci√≥n
    actualizarNavegacion();
    
    // Notificar cambio de estado
    notificarCambioAuth("login", userData);
    
    console.log("‚úÖ Sesi√≥n iniciada correctamente");
    return true;
  } catch (error) {
    console.error("‚ùå Error iniciando sesi√≥n:", error);
    return false;
  }
}

/**
 * Cierra sesi√≥n del usuario
 */
function cerrarSesion() {
  console.log("üö™ Cerrando sesi√≥n...");
  
  // Confirmar logout
  if (confirm("¬øEst√°s seguro que quer√©s cerrar sesi√≥n?")) {
    try {
      // Limpiar storage
      localStorage.removeItem(CONFIG_AUTH.storage_keys.user_token);
      localStorage.removeItem(CONFIG_AUTH.storage_keys.user_data);
      localStorage.removeItem(CONFIG_AUTH.storage_keys.remember_me);
      
      sessionStorage.removeItem(CONFIG_AUTH.storage_keys.user_token);
      sessionStorage.removeItem(CONFIG_AUTH.storage_keys.user_data);
      
      // Resetear estado
      usuarioActual = null;
      estaAutenticado = false;
      
      // Actualizar navegaci√≥n
      actualizarNavegacion();
      
      // Notificar cambio de estado
      notificarCambioAuth("logout", null);
      
      // Redirigir a home
      navegarA(CONFIG_AUTH.rutas.home);
      
      console.log("‚úÖ Sesi√≥n cerrada correctamente");
    } catch (error) {
      console.error("‚ùå Error cerrando sesi√≥n:", error);
    }
  }
}

// ===============================================
// NAVEGACI√ìN Y REDIRECCIONES
// ===============================================

/**
 * Navega a una URL espec√≠fica
 */
function navegarA(url) {
  console.log(`üß≠ Navegando a: ${url}`);
  
  // Verificar si necesita autenticaci√≥n
  if (url.includes("/private/dashboard/") && !estaAutenticado) {
    console.log("üîí Ruta protegida, redirigiendo a login");
    redirigirALogin(url);
    return;
  }
  
  // Navegar
  window.location.href = url;
}

/**
 * Redirige al login guardando la URL de destino
 */
function redirigirALogin(urlDestino = null) {
  console.log("üîê Redirigiendo a login...");
  
  if (urlDestino) {
    sessionStorage.setItem("redirect_after_login", urlDestino);
  }
  
  window.location.href = CONFIG_AUTH.rutas.login;
}

/**
 * Redirige despu√©s del login exitoso
 */
function redirigirDespuesLogin() {
  const redirectUrl = sessionStorage.getItem("redirect_after_login");
  
  if (redirectUrl) {
    sessionStorage.removeItem("redirect_after_login");
    console.log("üéØ Redirigiendo a URL guardada:", redirectUrl);
    window.location.href = redirectUrl;
  } else {
    console.log("üè† Redirigiendo a dashboard");
    window.location.href = CONFIG_AUTH.rutas.dashboard;
  }
}

// ===============================================
// UTILIDADES Y VALIDACIONES
// ===============================================

/**
 * Verifica si una ruta requiere autenticaci√≥n
 */
function rutaRequiereAuth(url) {
  return url.includes("/private/dashboard/");
}

/**
 * Obtiene informaci√≥n del usuario actual
 */
function obtenerUsuarioActual() {
  return usuarioActual;
}

/**
 * Verifica si el usuario est√° autenticado
 */
function estaLogueado() {
  return estaAutenticado;
}

/**
 * Valida token de sesi√≥n (simulado - en producci√≥n verificar con backend)
 */
function validarToken(token) {
  // Simulaci√≥n - en producci√≥n hacer request al backend
  return token && token.length > 10;
}

// ===============================================
// EVENTOS Y NOTIFICACIONES
// ===============================================

/**
 * Configura event listeners globales
 */
function configurarEventListeners() {
  // Event listener para enlaces protegidos - DESHABILITADO EN DASHBOARD
  document.addEventListener("click", (e) => {
    // No interferir con navegaci√≥n en p√°ginas del dashboard
    if (window.location.pathname.includes('/private/dashboard/')) {
      return;
    }
    
    if (e.target.tagName === "A" && e.target.href) {
      const url = e.target.href;
      
      if (rutaRequiereAuth(url) && !estaAutenticado) {
        e.preventDefault();
        redirigirALogin(url);
      }
    }
  });
  
  // Event listener para cambios de storage (m√∫ltiples tabs)
  window.addEventListener("storage", (e) => {
    if (e.key === CONFIG_AUTH.storage_keys.user_token) {
      console.log("üîÑ Cambio de autenticaci√≥n detectado en otra tab");
      verificarEstadoAutenticacion();
      actualizarNavegacion();
    }
  });
  
  console.log("üîó Event listeners de auth configurados");
}

/**
 * Notifica cambios de estado de autenticaci√≥n
 */
function notificarCambioAuth(tipo, data) {
  const evento = new CustomEvent("authStateChanged", {
    detail: {
      tipo: tipo, // "login" o "logout"
      usuario: data,
      estaAutenticado: estaAutenticado
    }
  });
  
  document.dispatchEvent(evento);
  
  console.log("üì° Evento authStateChanged disparado:", tipo);
}

// ===============================================
// API P√öBLICA DEL M√ìDULO
// ===============================================

window.AuthManager = {
  // Inicializaci√≥n
  inicializar: inicializarAuth,
  
  // Estado
  estaLogueado: estaLogueado,
  obtenerUsuario: obtenerUsuarioActual,
  verificarEstado: verificarEstadoAutenticacion,
  
  // Sesiones
  iniciarSesion: iniciarSesion,
  cerrarSesion: cerrarSesion,
  
  // Navegaci√≥n
  navegarA: navegarA,
  redirigirALogin: redirigirALogin,
  redirigirDespuesLogin: redirigirDespuesLogin,
  
  // Utilidades
  rutaRequiereAuth: rutaRequiereAuth,
  validarToken: validarToken,
  
  // Navegaci√≥n
  actualizarNav: actualizarNavegacion,
  
  // Configuraci√≥n
  configuracion: CONFIG_AUTH
};

console.log("üì¶ AuthManager cargado");
